# Cline Supplemental Guide: Implementation & Future Coding
**Target**: Cline AI Code Assistant
**Scope**: Xoe-NovAi Stack (Ryzen/Vulkan/Rootless Podman)
**Version**: 1.0

## 1. Architectural Principles (The "Cline" Standard)
When modifying the Xoe-NovAi stack, Cline MUST adhere to these three core principles:

1.  **Sovereign Resilience**: Every operation must be local-first, zero-telemetry, and protected by a circuit breaker.
2.  **Hardware-Native Optimization**: Code should be optimized for the AMD Ryzen 5700U/Vulkan 1.4 target (low memory, high thread efficiency).
3.  **Namespace Harmony**: All file and system operations must be compliant with rootless user namespaces.

---

## 2. Implementation Guide for Remediations

### 2.1 Security & IAM (Priority: Critical)
- **Persistence**: When moving `UserDatabase` to SQLite, use the `sqlite-utils` library. Ensure session data is stored as encrypted JSON blobs within the table.
- **Bcrypt Standards**: Use a work factor of 12 for password hashing to balance security and Ryzen CPU latency.

### 2.2 Rootless Volume Ownership (Priority: Critical)
- **The "Unshare" Rule**: NEVER use `sudo chown` for container volumes in setup scripts. 
- **Instruction**: Use `podman unshare chown -R 1001:1001 <directory_path>`. This maps the files to the container's internal UID 1001.
- **SELinux**: Always append `:Z` to volume strings in `podman-compose.yml` to ensure automatic context labeling.

### 2.3 Hybrid Retrieval (Priority: High)
- **Aggregation**: Use Reciprocal Rank Fusion (RRF) for blending BM25 and FAISS results.
- **Default RRF Formula**: `score = 1 / (rank + 60)`.
- **Instruction**: Ensure that the `search` methods in `voice_command_handler.py` and `main.py` return a unified ranking based on this fusion.

### 2.4 Voice Resilience (Priority: High)
- **Emergency Audio**: Implement a local "Emergency Audio Vault" containing pre-recorded OGG/WAV files for system errors.
- **Logic**: If the Piper TTS service fails and the Circuit Breaker is OPEN, the `VoiceRecoveryManager` should stream the static error file directly to the client.

### 2.5 Sovereign Curation (Priority: High)
- **yt-dlp Implementation**: Use `yt-dlp` for all external media metadata extraction. This ensures a torch-free, browserless workflow that respects the sovereign AI principle.

---

## 3. Best Practices for Future Coding

### 3.1 Async Concurrency
- **Avoid**: `asyncio.gather(*tasks)`.
- **Prefer**: `async with anyio.create_task_group() as tg: tg.start_soon(...)`.
- **Reason**: AnyIO provides better cancellation propagation and resource cleanup, preventing "zombie" tasks on Ryzen's 16-thread architecture.

### 3.2 Hardware-Aware Data Structures
- **Bounded Buffers**: Use `collections.deque(maxlen=N)` for all real-time audio and log buffers to prevent memory leaks.
- **Fsync Strategy**: Always follow "Pattern 4" for data persistence: Write file -> `fsync()` file -> `fsync()` parent directory -> Rename. This ensures data durability on AMD Ryzen storage controllers.

### 3.3 Logging & PII
- **Traceability**: Every log entry must include a `correlation_id` and `request_id`.
- **Redaction**: NEVER log raw user input or voice transcriptions in production. Use `sha256(data)[:8]` for correlation purposes in non-debug logs.

---

## 4. Operational SOP for Cline
Before submitting a code change, **Cline** should perform this mental checklist:
1. "Does this change introduce a dependency on HuggingFace/External APIs?" (Must be NO)
2. "Does this volume change work in rootless mode?" (Must be YES)
3. "Is there a circuit breaker for this new service call?" (Must be YES)
4. "Does this code utilize Ryzen's 6-core/12-thread target effectively?" (Must be YES)

---
*Manual Generated By: Gemini CLI for Cline*
