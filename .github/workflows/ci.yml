name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ===========================================================================
  # Linting - Fast feedback on code quality
  # ===========================================================================
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install Ruff
      run: pip install ruff
    - name: Ruff Lint
      run: ruff check --output-format=github app/ tests/
    - name: Ruff Format Check
      run: ruff format --check app/ tests/

  # ===========================================================================
  # Multi-Python Testing with Tox Matrix
  # ===========================================================================
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
        include:
          - python-version: '3.11'
            tox-env: py311
          - python-version: '3.12'
            tox-env: py312
          - python-version: '3.13'
            tox-env: py313

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        allow-prereleases: true
    
    - name: Install tox
      run: |
        python -m pip install --upgrade pip
        pip install tox tox-gh-actions
    
    - name: Run tests with tox
      run: tox -e ${{ matrix.tox-env }}
    
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ matrix.tox-env }}
        path: coverage-${{ matrix.tox-env }}.xml
        if-no-files-found: ignore
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage-${{ matrix.tox-env }}.xml
        flags: ${{ matrix.tox-env }}
        fail_ci_if_error: false

  # ===========================================================================
  # Type Checking
  # ===========================================================================
  typecheck:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install tox
      run: pip install tox
    - name: Run mypy via tox
      run: tox -e typecheck

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install tox
      run: pip install tox
    - name: Run security scan via tox
      run: tox -e security
      continue-on-error: true

  # ===========================================================================
  # Security Gate - Blocking Security Check
  # ===========================================================================
  security-gate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    - name: Run Bandit security linter
      run: bandit -r app/ -ll --skip B101,B311
    - name: Check for known vulnerabilities
      run: safety check --full-report
      continue-on-error: true  # Safety DB may have false positives

  # ===========================================================================
  # Coverage Report (after all tests pass)
  # ===========================================================================
  coverage:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install coverage
      run: pip install coverage
    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: coverage-*
        path: .
        merge-multiple: true
      continue-on-error: true
    - name: Generate coverage report
      run: |
        coverage combine coverage-py3*.xml || true
        coverage report --fail-under=80 || echo "Coverage threshold not met"
        coverage html -d htmlcov
      continue-on-error: true
    - name: Upload coverage HTML
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/

  # ===========================================================================
  # Summary Job
  # ===========================================================================
  ci-passed:
    runs-on: ubuntu-latest
    needs: [lint, test, typecheck, security]
    if: always()
    steps:
    - name: Check CI Status
      run: |
        if [[ "${{ needs.test.result }}" != "success" ]]; then
          echo "❌ Tests failed"
          exit 1
        fi
        if [[ "${{ needs.lint.result }}" != "success" ]]; then
          echo "⚠️ Linting failed"
        fi
        if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
          echo "⚠️ Type checking failed"
        fi
        echo "✅ CI completed"