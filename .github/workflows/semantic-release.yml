# Semantic Release Workflow
# =========================
# Automates version bumping and changelog generation based on conventional commits.
#
# Triggers:
# - Push to main branch
# - Manual dispatch
#
# Requirements:
# - Conventional commit messages (feat:, fix:, etc.)
# - GITHUB_TOKEN with write permissions

name: Semantic Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'chore(release):')"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system python-semantic-release>=9.0.0
          uv pip install --system build

      - name: Run semantic release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release version
          semantic-release publish

      - name: Build package
        if: steps.release.outputs.new_release_published == 'true'
        run: |
          uv build

      - name: Upload artifacts
        if: steps.release.outputs.new_release_published == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30

  # Summary job for status checks
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: release
    if: always()
    
    steps:
      - name: Check release status
        run: |
          echo "## Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "✅ Release workflow completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Release workflow completed with status: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggered by" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
