# ============================================================================
# Tox Configuration - Multi-Environment Testing
# ============================================================================
# Purpose: Test across Python 3.11, 3.12, 3.13 with coverage
# Usage: tox (runs all environments) or tox -e py311 (specific version)
# ============================================================================

[tox]
envlist = 
    py311
    py312
    py313
    lint
    typecheck
    coverage
minversion = 4.0
isolated_build = True
skip_missing_interpreters = True

# ============================================================================
# Test Environments
# ============================================================================

[testenv]
description = Run tests with pytest
deps = 
    pytest>=7.4.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.1.0
    pytest-xdist>=3.5.0
    hypothesis>=6.80.0
    fakeredis>=2.0.0
    httpx>=0.27.0
    anyio>=4.0.0
extras = 
    qdrant
setenv =
    PYTHONDONTWRITEBYTECODE = 1
    PYTHONUNBUFFERED = 1
    PYTHONWARNDEFAULTENCODING = 1
    COVERAGE_PROCESS_START = {toxinidir}/pyproject.toml
passenv =
    CI
    GITHUB_*
    REDIS_*
    QDRANT_*
commands =
    pytest {posargs:tests} \
        -v \
        --tb=short \
        --asyncio-mode=auto \
        --cov=app/XNAi_rag_app \
        --cov-report=term-missing \
        --cov-report=xml:coverage-{envname}.xml \
        --cov-fail-under=0

# ============================================================================
# Python 3.11
# ============================================================================

[testenv:py311]
description = Test on Python 3.11
basepython = python3.11

# ============================================================================
# Python 3.12
# ============================================================================

[testenv:py312]
description = Test on Python 3.12
basepython = python3.12

# ============================================================================
# Python 3.13
# ============================================================================

[testenv:py313]
description = Test on Python 3.13
basepython = python3.13

# ============================================================================
# Linting
# ============================================================================

[testenv:lint]
description = Run ruff linting and formatting checks
basepython = python3.11
skip_install = true
deps =
    ruff>=0.9.0
commands =
    ruff check app/ tests/
    ruff format --check app/ tests/

# ============================================================================
# Type Checking
# ============================================================================

[testenv:typecheck]
description = Run mypy type checking
basepython = python3.11
deps =
    mypy>=1.8.0
    types-redis
    types-psutil
commands =
    mypy app/XNAi_rag_app \
        --config-file={toxinidir}/pyproject.toml \
        --ignore-missing-imports

# ============================================================================
# Coverage Reporting
# ============================================================================

[testenv:coverage]
description = Generate combined coverage report
basepython = python3.11
deps =
    coverage>=7.4.0
commands =
    coverage combine coverage-py3*.xml
    coverage report --fail-under=80
    coverage html -d htmlcov

# ============================================================================
# Security Scanning
# ============================================================================

[testenv:security]
description = Run security vulnerability scan
basepython = python3.11
skip_install = true
deps =
    safety>=3.0.0
    bandit>=1.7.0
commands =
    safety check --full-report
    bandit -r app/XNAi_rag_app -ll

# ============================================================================
# Pre-commit (runs all checks)
# ============================================================================

[testenv:precommit]
description = Run all pre-commit checks
basepython = python3.11
skip_install = true
deps =
    pre-commit>=3.6.0
commands =
    pre-commit run --all-files

# ============================================================================
# Development Environment
# ============================================================================

[testenv:dev]
description = Development environment with all tools
basepython = python3.11
usedevelop = true
deps =
    {[testenv]deps}
    {[testenv:lint]deps}
    {[testenv:typecheck]deps}
    ipython
    ipdb
commands =
    {posargs:python -m ipython}

# ============================================================================
# CI Configuration
# ============================================================================

[gh-actions]
python =
    3.11: py311, lint, typecheck
    3.12: py312
    3.13: py313

[gh-actions:env]
# Maps to GitHub Actions matrix