# XNAi Foundation - OpenCode Credentials Configuration
# 
# This file stores provider credentials for multi-account OpenCode dispatch.
# SECURITY: Keep this file private (0600 permissions) and git-ignored!
# 
# Environment Variable Override:
# Any value can be overridden by environment variable: XNAI_<PROVIDER>_<KEY>=value
# Example: XNAI_OPENCODE_ACCOUNT_1_API_KEY=sk-...
#
# Credential Injection:
# - Use scripts/xnai-inject-credentials.sh to inject into OpenCode runtime
# - Pre-injection validation checks token validity and connectivity
# - Automatic token refresh for OAuth-based providers
#
# Last Updated: 2026-02-23

credentials:
  opencode:
    # Multi-account OpenCode setup (supports 8+ concurrent instances)
    # XDG_DATA_HOME approach: Use environment variable per instance
    # 
    # Account 1-8: Antigravity OAuth (unlimited free tier)
    accounts:
      account_1:
        name: "Antigravity Account 1"
        auth_method: "oauth"
        provider: "google"
        oauth_token: "${XNAI_OPENCODE_ACCOUNT_1_OAUTH_TOKEN}"
        token_expiry: "2026-03-25T00:00:00Z"  # Estimated 30-day refresh
        models:
          - "gemini-3-pro-preview"
          - "gemini-3-flash-preview"
          - "claude-opus-4-6"
        quota_status: "active"
        
      account_2:
        name: "Antigravity Account 2"
        auth_method: "oauth"
        provider: "google"
        oauth_token: "${XNAI_OPENCODE_ACCOUNT_2_OAUTH_TOKEN}"
        token_expiry: "2026-03-26T00:00:00Z"
        models:
          - "gemini-3-pro-preview"
          - "gemini-3-flash-preview"
          - "claude-opus-4-6"
        quota_status: "active"
        
      account_3:
        name: "Antigravity Account 3"
        auth_method: "oauth"
        provider: "google"
        oauth_token: "${XNAI_OPENCODE_ACCOUNT_3_OAUTH_TOKEN}"
        token_expiry: "2026-03-27T00:00:00Z"
        models:
          - "gemini-3-pro-preview"
          - "gemini-3-flash-preview"
          - "claude-opus-4-6"
        quota_status: "active"
        
      # Additional accounts 4-8 can be configured similarly
      # Copy pattern above for accounts 4, 5, 6, 7, 8
      
    # XDG_DATA_HOME Override Pattern (for multi-instance isolation)
    # Usage: XDG_DATA_HOME=/tmp/opencode-instance-1 opencode chat "prompt"
    # Each instance gets isolated auth.json, preventing credential collision
    isolation_method: "xdg_data_home"
    
  copilot:
    # GitHub Copilot CLI (8 accounts @ 50 msgs/month each = 400 total)
    accounts:
      account_1:
        name: "Copilot Account 1"
        auth_method: "github_oauth"
        github_user: "${XNAI_COPILOT_ACCOUNT_1_USER}"
        oauth_token: "${XNAI_COPILOT_ACCOUNT_1_TOKEN}"
        token_expiry: "2026-02-24T08:00:00Z"  # ~8-12 hours
        models:
          - "raptor-mini"
          - "claude-haiku-4-5"
        quota_status: "messages_used_0_50"
        
      # Additional accounts 2-8 can be configured similarly
      
  cline:
    # Cline CLI (Anthropic API key - permanent, manual rotation)
    auth_method: "api_key"
    api_key: "${XNAI_CLINE_ANTHROPIC_API_KEY}"
    api_key_permanent: true
    last_rotated: "2026-02-01T00:00:00Z"
    rotation_schedule: "quarterly"
    models:
      - "claude-opus-4-6"
      - "claude-opus-4-6-fast"
    quota_status: "active"
    
  local_llm:
    # Local models via llama-cpp-python (sovereign, no credentials needed)
    auth_method: "none"
    models:
      - "mistral-7b"
      - "neural-chat-7b"
    quota_status: "unlimited"

# Token Validation & Refresh Configuration
# 
# Pre-injection checks before using any credential:
token_validation:
  enabled: true
  check_validity_before_use: true
  auto_refresh_if_expired: true
  refresh_buffer_minutes: 5  # Refresh 5 min before expiry
  
  provider_refresh_policies:
    opencode:
      lifetime_days: 30
      refresh_method: "oauth_plugin"
      refresh_endpoint: "https://accounts.google.com/o/oauth2/token"
      
    copilot:
      lifetime_hours: 12
      refresh_method: "gh_cli_auto"
      refresh_command: "gh auth refresh"
      
    cline:
      lifetime_days: "infinite"
      refresh_method: "manual_only"
      note: "Anthropic API keys don't expire; manual rotation only"

# Multi-Account Dispatch Configuration
dispatch_config:
  enabled: true
  account_rotation: "round_robin"
  least_used_prioritization: true
  
  # Gemini full-repo tasks (>100K tokens) route to account with most quota
  gemini_priority:
    context_threshold_tokens: 100000
    routing: "primary"
    fallback_on_quota_exhaustion: true
    
  # Copilot Raptor tasks route to any available account
  copilot_priority:
    routing: "load_balanced"
    max_concurrent_requests: 2
    
  # Cline file operations route to single API key
  cline_priority:
    routing: "dedicated"
    
# Quota Tracking & Alert Configuration
quota_management:
  tracking_enabled: true
  audit_collection_time: "02:00"  # 2 AM UTC daily
  audit_collection_timezone: "UTC"
  
  alert_thresholds:
    warning_percentage: 80
    critical_percentage: 90
    
  automatic_rotation:
    enabled: true
    on_exhaustion: true
    prioritize_least_used: true

# Security & Compliance
security:
  file_permissions: "0600"  # Owner read/write only
  encryption: "optional"     # Can use git-crypt or sops for repo
  keyring_support: true      # Can store sensitive values in system keyring
  audit_logging: true        # All credential access logged
  
  # Zero-telemetry compliance
  external_api_calls: false  # No credentials transmitted externally
  local_storage_only: true   # All credentials stored locally
  
# Metadata
metadata:
  version: "2.0"
  created: "2026-02-23T21:26:12Z"
  last_updated: "2026-02-23T21:26:12Z"
  owner: "xnai-foundation"
  region: "local-sovereign"
  status: "template"  # Change to "active" once populated with real credentials
