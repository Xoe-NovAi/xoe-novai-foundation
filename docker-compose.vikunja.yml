version: '3.8'

services:
  vikunja-db:
    image: postgres:16-alpine
    container_name: xnai_vikunja_db
    user: "1001:1001"
    restart: unless-stopped
    environment:
      POSTGRES_USER: vikunja
      POSTGRES_PASSWORD: ${VIKUNJA_DB_PASSWORD}
      POSTGRES_DB: vikunja
    volumes:
      - ./data/vikunja/db:/var/lib/postgresql/data:Z
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vikunja"]
      start_period: 30s
    networks: [xnai_network]

  vikunja:
    image: vikunja/vikunja:0.24.1
    container_name: xnai_vikunja
    user: "1001:1001"
    restart: unless-stopped
    depends_on:
      vikunja-db: {condition: service_healthy}
    environment:
      VIKUNJA_DATABASE_TYPE: postgres
      VIKUNJA_DATABASE_HOST: vikunja-db
      VIKUNJA_DATABASE_USER: vikunja
      VIKUNJA_DATABASE_PASSWORD: ${VIKUNJA_DB_PASSWORD}
      VIKUNJA_DATABASE_DATABASE: vikunja
      VIKUNJA_SERVICE_PUBLICURL: http://localhost:8000/vikunja
      VIKUNJA_JWT_SECRET: ${VIKUNJA_JWT_SECRET}
      VIKUNJA_CORS_ENABLE: "false"
      VIKUNJA_FILES_MAXSIZE: "20971520"
      VIKUNJA_LOGGER_LEVEL: "info"
      VIKUNJA_MAILER_ENABLED: "false"
      VIKUNJA_REDIS_ENABLED: "true"
      VIKUNJA_REDIS_HOST: redis:6379
      VIKUNJA_REDIS_PORT: "6379"
      VIKUNJA_REDIS_PASSWORD: ${REDIS_PASSWORD}
      VIKUNJA_REDIS_DB: "5"
    volumes:
      - ./data/vikunja/files:/app/vikunja/files:Z
    tmpfs:
      - /tmp:size=100m
      - /app/vikunja/.cache:size=50m
    networks: [xnai_network]

networks:
  xnai_network:
    external: true
