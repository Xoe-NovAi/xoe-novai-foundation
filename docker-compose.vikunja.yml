version: '3.8'

services:
  vikunja-db:
    image: postgres:16
    container_name: vikunja-db
    user: "1000:1000"  # Rootless non-root
    restart: unless-stopped
    environment:
      POSTGRES_USER: vikunja
      POSTGRES_PASSWORD_FILE: /run/secrets/db-pass
      POSTGRES_DB: vikunja
    volumes:
      - ./db:/var/lib/postgresql/data:Z,U
    secrets:
      - db-pass
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vikunja"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - vikunja-net

  vikunja-api:
    image: vikunja/api:latest
    container_name: vikunja-api
    user: "1000:1000"
    restart: unless-stopped
    depends_on:
      vikunja-db:
        condition: service_healthy
    environment:
      VIKUNJA_DATABASE_TYPE: postgres
      VIKUNJA_DATABASE_HOST: vikunja-db
      VIKUNJA_DATABASE_PORT: 5432
      VIKUNJA_DATABASE_USER: vikunja
      VIKUNJA_DATABASE_PASSWORD_FILE: /run/secrets/db-pass
      VIKUNJA_DATABASE_DATABASE: vikunja
      VIKUNJA_SERVICE_PUBLICURL: http://localhost:3456
      VIKUNJA_JWT_SECRET_FILE: /run/secrets/jwt-secret
      VIKUNJA_CORS_ENABLE: "false"
    volumes:
      - ./files:/app/vikunja/files:Z,U
    secrets:
      - db-pass
      - jwt-secret
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3456/api/v1/info"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - vikunja-net

  vikunja-frontend:
    image: vikunja/frontend:latest
    container_name: vikunja-frontend
    user: "1000:1000"
    restart: unless-stopped
    depends_on:
      vikunja-api:
        condition: service_healthy
    environment:
      VIKUNJA_API_URL: /api/v1
    networks:
      - vikunja-net

  caddy-proxy:
    image: caddy:latest
    container_name: vikunja-proxy
    restart: unless-stopped
    ports:
      - "3456:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:Z,U
    depends_on: [vikunja-frontend]
    networks:
      - vikunja-net

networks:
  vikunja-net:
    driver: bridge

secrets:
  db-pass:
    external: true
  jwt-secret:
    external: true
