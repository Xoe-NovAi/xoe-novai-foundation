version: '3.8'

# ============================================================================
# Vikunja Integration - Phase 1 v0.2.0 (BLOCKER #1-4 FIXED)
# ============================================================================
# Status: PRODUCTION-READY
# All Blockers Fixed:
#   ✅ #1: Environment variables instead of Podman secrets
#   ✅ #2: Explicit Redis HOST:PORT configuration
#   ✅ #3: Shared xnai_network (external)
#   ✅ #4: Clean YAML with proper dependencies
#
# Last Updated: 2026-02-09
# Deployed with: docker-compose + Podman (rootless)
# ============================================================================

services:
  # ==========================================================================
  # VIKUNJA DATABASE - PostgreSQL 16 Alpine
  # ==========================================================================
  vikunja-db:
    image: postgres:16-alpine
    container_name: xnai_vikunja_db
    restart: unless-stopped
    
    # Rootless Podman: user 1001:1001 (non-root)
    user: "1001:1001"
    
    # ============================================================================
    # BLOCKER #1 FIX: Use environment variables, NOT _FILE references
    # ============================================================================
    # OLD (BROKEN):
    #   POSTGRES_PASSWORD_FILE: /run/secrets/vikunja-db-pass
    # NEW (WORKS):
    #   POSTGRES_PASSWORD: ${VIKUNJA_DB_PASSWORD}
    # ============================================================================
    environment:
      POSTGRES_USER: vikunja
      POSTGRES_PASSWORD: ${VIKUNJA_DB_PASSWORD:?VIKUNJA_DB_PASSWORD must be set in .env}
      POSTGRES_DB: vikunja
    
    # Volume: PostgreSQL data directory
    volumes:
      - ./data/vikunja/db:/var/lib/postgresql/data:Z,U
    
    # Health check: PostgreSQL is ready to accept connections
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vikunja -h 127.0.0.1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    
    # Network: Share with Foundation stack (external)
    networks:
      - xnai_network
    
    # Security: Drop all capabilities, non-root user
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    
    read_only: false  # PostgreSQL needs write access to data directory


  # ==========================================================================
  # VIKUNJA APPLICATION - Task Management & Coordination
  # ==========================================================================
  vikunja:
    image: vikunja/vikunja:0.24.1
    container_name: xnai_vikunja
    restart: unless-stopped
    
    # Rootless Podman: user 1001:1001 (non-root)
    user: "1001:1001"
    
    # Dependency: Wait for PostgreSQL to be healthy
    depends_on:
      vikunja-db:
        condition: service_healthy
    
    # ============================================================================
    # BLOCKER #1-2 FIX: ALL environment variables (no _FILE references)
    # ============================================================================
    # Database Connection
    environment:
      # --- PostgreSQL Database ---
      VIKUNJA_DATABASE_TYPE: postgres
      VIKUNJA_DATABASE_HOST: vikunja-db
      VIKUNJA_DATABASE_PORT: 5432
      VIKUNJA_DATABASE_USER: vikunja
      VIKUNJA_DATABASE_PASSWORD: ${VIKUNJA_DB_PASSWORD:?VIKUNJA_DB_PASSWORD must be set}
      VIKUNJA_DATABASE_DATABASE: vikunja
      
      # Connection Pool Optimization (Ryzen 5700U)
      VIKUNJA_DATABASE_MAXOPENCONNECTIONS: 20
      VIKUNJA_DATABASE_MAXIDLECONNECTIONS: 5
      VIKUNJA_DATABASE_CONNMAXLIFETIME: 0  # No limit
      
      # --- Service Configuration ---
      VIKUNJA_SERVICE_PUBLICURL: http://localhost/vikunja
      VIKUNJA_SERVICE_JWTEXPIRATION: 86400  # 24 hours
      VIKUNJA_SERVICE_JWTSECRET: ${VIKUNJA_JWT_SECRET:?VIKUNJA_JWT_SECRET must be set}
      
      # ============================================================================
      # BLOCKER #2 FIX: Explicit REDIS_HOST and REDIS_PORT (not host:port)
      # ============================================================================
      # OLD (BROKEN): "redis:6379" in one variable
      # NEW (WORKS): Separate VIKUNJA_REDIS_HOST and VIKUNJA_REDIS_PORT
      # ============================================================================
      VIKUNJA_REDIS_ENABLED: "true"
      VIKUNJA_REDIS_HOST: redis
      VIKUNJA_REDIS_PORT: "6379"  # MUST be quoted string, MUST be explicit
      VIKUNJA_REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
      VIKUNJA_REDIS_DB: "5"  # Foundation uses DB 0-4, Vikunja uses 5 (isolated)
      
      # --- Calendar & Sync ---
      VIKUNJA_ENABLECALENDAR: "true"
      VIKUNJA_ENABLESYNC: "false"  # Air-gapped (no external sync)
      
      # --- Files ---
      VIKUNJA_FILES_MAXSIZE: 20971520  # 20 MB
      
      # --- Logging ---
      VIKUNJA_LOGGER_LEVEL: info
      
      # --- Email (disabled for air-gap) ---
      VIKUNJA_MAILER_ENABLED: "false"
      
      # --- CORS (disabled for security) ---
      VIKUNJA_CORS_ENABLE: "false"
    
    # Volumes: Persistent storage
    volumes:
      # File attachments (task attachments, uploads)
      - ./data/vikunja/files:/app/vikunja/files:Z,U
    
    # Temporary filesystems (not persisted)
    tmpfs:
      # Cache directory (50 MB limit)
      - /app/vikunja/.cache:size=50m
      # /tmp directory (100 MB limit)
      - /tmp:size=100m
    
    # Health check: API is responding
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:3456/api/v1/info || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s  # Wait 60s for first check (migrations take time)
    
    # ============================================================================
    # BLOCKER #3 FIX: Use external xnai_network (not isolated vikunja-net)
    # ============================================================================
    # OLD (BROKEN):
    #   networks: [vikunja-net]
    #   (new isolated network)
    # NEW (WORKS):
    #   networks: [xnai_network]
    #   (shared with Foundation - service-level isolation sufficient)
    # ============================================================================
    networks:
      - xnai_network
    
    # Security: Restrict capabilities (least privilege)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true


# ============================================================================
# NETWORKS - External (shared with Foundation Stack)
# ============================================================================
networks:
  xnai_network:
    # ============================================================================
    # BLOCKER #3 FIX: Reference existing Foundation network (external: true)
    # ============================================================================
    # OLD (BROKEN):
    #   driver: bridge
    #   name: vikunja-net  (new isolated network)
    # NEW (WORKS):
    #   external: true  (reference existing xnai_network)
    # ============================================================================
    external: true


# ============================================================================
# SECRETS - REMOVED (Use environment variables instead)
# ============================================================================
# OLD (BROKEN):
#   secrets:
#     vikunja-db-pass:
#       external: true
#
# WHY REMOVED:
#   - Podman secrets don't mount in docker-compose overlay files
#   - User namespace remapping breaks secret file access
#   - Environment variables are 100% reliable
#   - Already defined in .env file: VIKUNJA_DB_PASSWORD, VIKUNJA_JWT_SECRET
#
# NEW APPROACH:
#   - All passwords in .env as environment variables
#   - .env in .gitignore (not committed to git)
#   - docker-compose substitutes at runtime: ${VARIABLE_NAME}
#   - Works with all platforms (Docker, Podman, Kubernetes)
# ============================================================================


# ============================================================================
# CONFIGURATION NOTES
# ============================================================================
#
# 1. ENVIRONMENT VARIABLES (.env file required)
#    ├─ VIKUNJA_DB_PASSWORD: Generate with: openssl rand -base64 32
#    ├─ VIKUNJA_JWT_SECRET: Generate with: openssl rand -base64 64
#    ├─ REDIS_PASSWORD: From Foundation stack (.env)
#    └─ Must be in .env file, .env must be in .gitignore
#
# 2. DATA DIRECTORIES (must exist with correct permissions)
#    ├─ mkdir -p data/vikunja/{db,files}
#    ├─ podman unshare chown -R 1001:1001 data/vikunja
#    ├─ chmod 700 data/vikunja/db (PostgreSQL data, restricted)
#    └─ chmod 755 data/vikunja/files (attachments, readable)
#
# 3. NETWORK (must exist)
#    ├─ Foundation creates xnai_network on startup
#    ├─ xnai_network is bridge type
#    ├─ Services communicate via DNS: vikunja-db, redis, rag, etc.
#    └─ Service names resolve via container DNS
#
# 4. STARTUP ORDER
#    ├─ Foundation starts first: Redis, RAG API, UI, Caddy
#    ├─ xnai_network created by Foundation
#    ├─ Then start Vikunja: Database first, then application
#    └─ Vikunja waits for PostgreSQL health check
#
# 5. SECURITY
#    ├─ Rootless Podman: all containers run as UID 1001:1001
#    ├─ Drop all capabilities: reduced attack surface
#    ├─ Read-only filesystems where possible
#    ├─ tmpfs for temporary files: /tmp, /app/vikunja/.cache
#    └─ No passwords in version control (.env in .gitignore)
#
# ============================================================================


# ============================================================================
# DEPLOYMENT STEPS
# ============================================================================
#
# 1. Generate Secrets (2 min)
#    VIKUNJA_DB_PASSWORD=$(openssl rand -base64 32)
#    VIKUNJA_JWT_SECRET=$(openssl rand -base64 64)
#    echo "VIKUNJA_DB_PASSWORD=$VIKUNJA_DB_PASSWORD" >> .env
#    echo "VIKUNJA_JWT_SECRET=$VIKUNJA_JWT_SECRET" >> .env
#
# 2. Prepare Directories (2 min)
#    mkdir -p data/vikunja/{db,files}
#    podman unshare chown -R 1001:1001 data/vikunja
#    chmod 700 data/vikunja/db && chmod 755 data/vikunja/files
#
# 3. Validate Configuration (1 min)
#    podman-compose -f docker-compose.yml -f docker-compose_vikunja.yml config
#
# 4. Start Foundation (if not running) (5 min)
#    podman-compose -f docker-compose.yml up -d
#
# 5. Deploy Vikunja (5 min)
#    podman-compose -f docker-compose.yml -f docker-compose_vikunja.yml up -d
#
# 6. Wait for Startup (2 min)
#    sleep 60
#
# 7. Verify (3 min)
#    podman ps | grep vikunja
#    curl http://localhost:3456/api/v1/info | jq .
#
# TOTAL: ~25 minutes
#
# ============================================================================
