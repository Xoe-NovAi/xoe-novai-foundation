# üî± Xoe-NovAi Foundation Stack Master Guide: Elite Sovereign Infrastructure
**Date**: January 27, 2026
**Version**: 1.0
**Author**: Stack Researcher Agent

## üìã Overview
This guide provides the definitive standards for the Xoe-NovAi sovereign stack, focusing on performance, accessibility, and absolute data sovereignty.

---

## ‚ö° 1. BuildKit Optimization Mastery
We utilize a **Triple-Layer Caching Strategy** to achieve "Elite" build speeds (< 45s warm).

### 1.1. Implementation Standards
Always use namespaced cache IDs and explicit UID/GID mapping for rootless Podman.

```dockerfile
# syntax=docker/dockerfile:1
FROM xnai-base:latest

# Layer 1: System (apt)
RUN --mount=type=cache,id=xnai-apt-cache,target=/var/cache/apt,uid=1001,gid=1001 \
    --mount=type=cache,id=xnai-apt-lists,target=/var/lib/apt,uid=1001,gid=1001 \
    apt-get update && apt-get install -y --no-install-recommends ...

# Layer 2: Python (uv)
RUN --mount=type=cache,id=xnai-pip-cache,target=/root/.cache/pip,uid=1001,gid=1001 \
    --mount=type=cache,id=xnai-uv-cache,target=/root/.cache/uv,uid=1001,gid=1001 \
    uv pip install --system -r requirements.txt
```

### 1.2. Key Constraints
*   **No `sharing=locked`**: Avoid this in rootless Podman 5.x to prevent overlay driver errors.
*   **Syntax Line 1**: The `# syntax` directive must be the absolute first line.

---

## üì¶ 2. uv System-Level Standardization
We have replaced `pip` and `wheelhouse` with `uv` for 10-100x installation speedups.

### 2.1. Best Practices
*   **System-Level Install**: Use `uv pip install --system` inside containers. Virtualenvs are redundant in isolated container environments.
*   **Bytecode Compilation**: Set `ENV UV_COMPILE_BYTECODE=1` to optimize application startup.
*   **Pinned Versions**: Always pin the `uv` version in `Dockerfile.base` (currently `0.5.21`).

---

## üåê 3. Podman 5.x Rootless Networking
The transition to the **pasta** driver is mandatory for Podman 5.x.

### 3.1. MTU Alignment
*   **Standard**: MTU 1500.
*   **Why**: `pasta` defaults to 65520, which causes fragmentation and high CPU usage on standard 1500 MTU host interfaces.
*   **Fix**: Explicitly set MTU in `docker-compose.yml` or network creation:
    ```bash
    podman network create -o mtu=1500 xnai_network
    ```

### 3.2. Performance
*   Use `host.containers.internal` for host-to-container communication.
*    ‡§ó‡•ç‡§∞‡•Å‡§™ related containers in Pods for sub-microsecond IPC latency.

---

## üîç 4. RRF Standard for Hybrid Search
We use **Reciprocal Rank Fusion (RRF)** to combine Semantic (Dense) and Lexical (BM25) search.

### 4.1. Configuration
*   **Parameter `k`**: 60 (The industry gold standard for robustness).
*   **Targets**: Latency < 100ms for retrieval; NDCG@10 > 0.85.
*   **Pattern**: Combine FAISS (Semantic) with BM25 (Exact Match) to handle both conceptual queries and specific technical terms.

---

## ‚öñÔ∏è 5. Ma'at Principle Implementation
All code must adhere to the 42 Laws of Ma'at, translated into technical guardrails.

### 5.1. Sovereignty (Laws 1-3)
*   **Zero Telemetry**: All `ANALYTICS=true` flags must be disabled (e.g., `SCARF_NO_ANALYTICS=true`, `CHAINLIT_NO_TELEMETRY=true`).
*   **Offline-First**: Use local GGUF/ONNX models only. No OpenAI/Anthropic API dependencies in production.

### 5.2. Justice (Laws 4-6)
*   **Resource Fairness**: Ryzen core steering (0-11 for AI, 12-15 for system) ensures inference doesn't starve background services.

---

## üö® 6. Blocker Audit: Turn Management
To prevent turn waste, agents must follow the **Git-Ignore Awareness Protocol**.

### 6.1. The .gitignore Blocker
Agents often waste 5+ turns trying to find files hidden by `.gitignore`.
*   **Fix**: If a file is known to exist but hidden from `glob`, use `run_shell_command("cat <path>")` immediately.
*   **Audit**: Any task wasting >2 turns on a single file path must be logged in the `Turn Auditor`.

---

## üìà 7. Performance Benchmarks (2026 Target)
*   **Build Velocity**: < 45s (Warm).
*   **Inference Latency**: < 300ms (Voice-to-Voice).
*   **RAM Footprint**: < 5.6GB (70% Buffer Rule).

---
*Generated by the Xoe-NovAi Foundation Stack Researcher Agent.*
