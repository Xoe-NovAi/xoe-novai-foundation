# ============================================================================ 
# XNAi Foundation Stack - Phase 1 v0.1.7 (BuildKit Optimized)
# ============================================================================ 
# Purpose: Multi-service orchestration for the XNAi Foundation Stack.
# Optimized for: AMD Ryzen 5700U (Zen 2) | 8 Cores / 16 Threads
# Hardening: Zero-Trust, Rootless Podman, Ma'at Ethical Guardrails.
# ============================================================================ 

services:
  # ==========================================================================
  # CONSUL SERVICE - Service Discovery & Health Monitoring
  # ==========================================================================
  consul:
    image: consul:1.15.4
    container_name: xnai_consul
    init: true
    user: root
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.2'
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    volumes:
      - ./data/consul:/consul/data:Z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - xnai_network
    restart: unless-stopped

  # ==========================================================================
  # REDIS SERVICE - Cache & Streams Coordinator
  # ==========================================================================
  redis:
    image: redis:7.4.1
    container_name: xnai_redis
    init: true
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    command: redis-server --requirepass "${REDIS_PASSWORD:?REDIS_PASSWORD must be set}" --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - ./data/redis:/data:Z
    environment:
      - REDIS_PASSWORD
      - REDIS_STREAM_MAX_LEN=${REDIS_STREAM_MAX_LEN:-1000}
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli -a \"$REDIS_PASSWORD\" ping || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    networks:
      - xnai_network
    restart: unless-stopped

  # ==========================================================================
  # QDRANT SERVICE - Vector Database (Phase 3)
  # ==========================================================================
  qdrant:
    image: qdrant/qdrant:v1.13.1
    container_name: xnai_qdrant
    init: true
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage:Z
      - ./config/qdrant_config.yaml:/qdrant/config/config.yaml:ro
    environment:
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_HOST=0.0.0.0
      - QDRANT_PORT=6333
      - QDRANT_GRPC_PORT=6334
      - QDRANT_SNAPSHOT_RECOVERY=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - xnai_network
    restart: unless-stopped

  # ==========================================================================
  # RAG SERVICE - FastAPI Backend (Ryzen Tuned)
  # ==========================================================================
  rag:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: xnai-rag:latest
    container_name: xnai_rag_api
    init: true
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
    read_only: true
    tmpfs:
      - /tmp:size=512m,mode=1777
      - /var/run:size=64m,mode=0755
      - /app/.cache:size=100m,mode=0755
      - /app/logs:size=100m,mode=1777
      - /app/data:size=50m,mode=1777
    volumes:
      - ./config.toml:/app/config.toml:ro
      - ./models:/models:ro
      - ./embeddings:/embeddings:ro
      - ./library:/library:z
      - ./knowledge:/knowledge:z
      - ./data/faiss_index:/app/data/faiss_index:Z
      - ./backups:/backups:Z
      - ./data/prometheus-multiproc:/prometheus_data:Z
      - ./app/XNAi_rag_app:/app/XNAi_rag_app:ro
    environment:
      # --- RYZEN ZEN 2 OPTIMIZATIONS ---
      - OPENBLAS_CORETYPE=ZEN
      - OPENBLAS_NUM_THREADS=6
      - LLAMA_CPP_N_THREADS=6
      - LLAMA_CPP_USE_MLOCK=true
      - LLAMA_CPP_USE_MMAP=true
      - OMP_NUM_THREADS=1
      # --- LLM CONFIGURATION ---
      - LLM_MODEL_PATH=/models/Qwen3-0.6B-Q6_K.gguf
      # --- NETWORK & API ---
      - RAG_API_URL=http://rag:8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - IAM_DB_PATH=/app/data/iam.db
      - JWT_PRIVATE_KEY_PATH=/app/data/jwt-private-key.pem
      - JWT_PUBLIC_KEY_PATH=/app/data/jwt-public-key.pem
      - LOG_DIR=/app/logs
      - API_KEY_FILE=/run/secrets/api_key
      - DEBUG_MODE=false
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    secrets:
      - redis_password
      - api_key
    networks:
      - xnai_network
    # ports:
    #   - "8002:8002" # Removed: metrics routed through Caddy /metrics
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    command:
      - sh
      - -c
      - |
        echo 'üöÄ Starting XNAi Foundation RAG API...'
        [ -f /run/secrets/redis_password ] || (echo '‚ùå Missing Redis Secret' && exit 1)
        uvicorn XNAi_rag_app.api.entrypoint:app --host 0.0.0.0 --port 8000 --log-level info

  # ==========================================================================
  # UI SERVICE - Chainlit Frontend (Voice Enabled)
  # ==========================================================================
  ui:
    build:
      context: .
      dockerfile: Dockerfile.chainlit
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: xnai-ui:latest
    container_name: xnai_chainlit_ui
    init: true
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
    tmpfs:
      - /app/logs:size=100m,mode=1777
    volumes:
      - ./config.toml:/app/config.toml:ro
      - ./models:/models:ro
      - ./app/XNAi_rag_app:/app/XNAi_rag_app
      - ./assets:/app/assets
    environment:
      - OPENBLAS_CORETYPE=ZEN
      - OPENBLAS_NUM_THREADS=6
      - CHAINLIT_PORT=8001
      - CHAINLIT_NO_TELEMETRY=true
      - RAG_API_URL=http://rag:8000
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - LOG_DIR=/app/logs
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    depends_on:
      redis:
        condition: service_healthy
      rag:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s
    networks:
      - xnai_network
    ports:
      - "8001:8001"
    restart: unless-stopped
    command:
      - sh
      - -c
      - |
        echo 'üöÄ Starting XNAi Foundation UI...'
        chainlit run XNAi_rag_app/ui/chainlit_app_voice.py --host 0.0.0.0 --port 8001

  # ==========================================================================
  # CRAWLER SERVICE - Ingestion Engine
  # ==========================================================================
  crawler:
    build:
      context: .
      dockerfile: Dockerfile.crawl
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: xnai-crawler:latest
    container_name: xnai_crawler
    init: true
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
    volumes:
      - ./config.toml:/app/config.toml:ro
      - ./library:/library:z
      - ./knowledge:/knowledge:z
      - ./data/cache:/app/cache:Z
      - ./app/XNAi_rag_app:/app/XNAi_rag_app
      - /tmp/crawl4ai:/app/.crawl4ai
      - /tmp/crawler_logs:/app/logs
    environment:
      - OPENBLAS_CORETYPE=ZEN
      - N_THREADS=6
      - CRAWL4AI_NO_TELEMETRY=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - LIBRARY_PATH=/library
      - KNOWLEDGE_PATH=/knowledge
      - LOG_DIR=/app/logs
    depends_on:
      redis:
        condition: service_healthy
      rag:
        condition: service_healthy
    networks:
      - xnai_network
    restart: unless-stopped
    command: ["sh", "-c", "echo 'üöÄ Crawler service standby...' && while true; do sleep 3600; done"]

  # ==========================================================================
  # CURATION WORKER - Knowledge Refinement
  # ==========================================================================
  curation_worker:
    build:
      context: .
      dockerfile: Dockerfile.curation_worker
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: xnai-curation-worker:latest
    container_name: xnai_curation_worker
    init: true
    restart: on-failure
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
    depends_on:
      - redis
    environment:
      - OPENBLAS_CORETYPE=ZEN
      - OPENBLAS_NUM_THREADS=6
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DATA_DIR=/app/data/curations
      - LOG_DIR=/app/logs/curations
      - PYTHONPATH=/app
    volumes:
      - ./data/curations:/app/data/curations:Z
      - ./logs/curations:/app/logs/curations:Z
      - ./app/XNAi_rag_app:/app/XNAi_rag_app:ro
    networks:
      - xnai_network

  # ==========================================================================
  # MKDOCS SERVICE - Foundation Documentation
  # ==========================================================================
  mkdocs:
    build:
      context: .
      dockerfile: Dockerfile.docs
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: xnai-mkdocs:latest
    container_name: xnai_mkdocs
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.2'
    volumes:
      - ./mkdocs.yml:/workspace/mkdocs.yml:ro
      - ./docs:/workspace/docs:ro
      - ./docs-new:/workspace/docs-new:ro
    environment:
      - OPENBLAS_CORETYPE=ZEN
      - N_THREADS=2
    networks:
      - xnai_network
    ports:
      - "8008:8000"
    restart: unless-stopped
    command:
      - sh
      - -c
      - |
        echo 'üöÄ Starting XNAi Foundation Docs...'
        cd /workspace && mkdocs serve --config-file mkdocs.yml --dev-addr=0.0.0.0:8000

  # ==========================================================================
  # VIKUNJA - Project Management & Knowledge Base Hub
  # ==========================================================================
  vikunja-db:
    image: postgres:16-alpine
    container_name: xnai_vikunja_db
    user: "1001:1001"
    restart: unless-stopped
    environment:
      POSTGRES_USER: vikunja
      POSTGRES_PASSWORD: ${VIKUNJA_DB_PASSWORD:-vikunja123}
      POSTGRES_DB: vikunja
    volumes:
      - ./data/vikunja/db:/var/lib/postgresql/data:Z
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vikunja"]
      start_period: 30s
    networks:
      - xnai_network

  vikunja:
    image: vikunja/vikunja:0.24.1
    container_name: xnai_vikunja
    user: "1001:1001"
    restart: unless-stopped
    depends_on:
      vikunja-db:
        condition: service_healthy
    environment:
      VIKUNJA_DATABASE_TYPE: postgres
      VIKUNJA_DATABASE_HOST: vikunja-db
      VIKUNJA_DATABASE_USER: vikunja
      VIKUNJA_DATABASE_PASSWORD: ${VIKUNJA_DB_PASSWORD:-vikunja123}
      VIKUNJA_DATABASE_DATABASE: vikunja
      VIKUNJA_SERVICE_PUBLICURL: http://localhost:8000/vikunja
      VIKUNJA_JWT_SECRET: ${VIKUNJA_JWT_SECRET:-changeme_jwt}
      VIKUNJA_CORS_ENABLE: "false"
      VIKUNJA_REDIS_ENABLED: "true"
      VIKUNJA_REDIS_HOST: redis:6379
      VIKUNJA_REDIS_PORT: "6379"
      VIKUNJA_REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme123}
      VIKUNJA_REDIS_DB: "5"
    volumes:
      - ./data/vikunja/files:/app/vikunja/files:Z
    networks:
      - xnai_network

  # ==========================================================================
  # CADDY SERVICE - Unified Reverse Proxy
  # ==========================================================================
  caddy:
    image: caddy:2.8-alpine
    container_name: xnai_caddy
    user: "${APP_UID:-1001}:${APP_GID:-1001}"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.2'
    ports:
      - "8000:8000"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro,Z
      - ./logs/caddy:/var/log/caddy:Z
    networks:
      - xnai_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============================================================================ 
# NETWORKS & VOLUMES
# ============================================================================ 
networks:
  xnai_network:
    driver: bridge
    name: xnai_network

secrets:
  redis_password:
    file: ./secrets/redis_password.txt
  api_key:
    file: ./secrets/api_key.txt
