# ============================================================================
# Xoe-NovAi Production Docker Compose
# ============================================================================
# Usage: podman-compose -f docker-compose.production.yml up -d
# Or:    docker compose -f docker-compose.production.yml up -d
# ============================================================================

version: "3.9"

services:
  # ===========================================================================
  # RAG API Service
  # ===========================================================================
  rag-api:
    build:
      context: .
      dockerfile: containers/Containerfile.production
      target: production
    image: xnai-rag:${VERSION:-0.2.0}
    container_name: xnai-rag-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - QDRANT_URL=http://qdrant:6333
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=production
    volumes:
      - rag-data:/app/data
      - rag-logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - xnai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=8000"
      - "prometheus.io/path=/metrics"

  # ===========================================================================
  # Redis - State Management
  # ===========================================================================
  redis:
    image: redis:7.4-alpine
    container_name: xnai-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - xnai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Qdrant - Vector Database
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: xnai-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      - QDRANT__LOG_LEVEL=INFO
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - xnai-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Consul - Service Discovery
  # ===========================================================================
  consul:
    image: consul:1.15
    container_name: xnai-consul
    restart: unless-stopped
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    volumes:
      - consul-data:/consul/data
    networks:
      - xnai-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Caddy - Reverse Proxy
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    container_name: xnai-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - xnai-network
    depends_on:
      - rag-api
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# Networks
# =============================================================================
networks:
  xnai-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  rag-data:
    driver: local
  rag-logs:
    driver: local
  redis-data:
    driver: local
  qdrant-data:
    driver: local
  consul-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local