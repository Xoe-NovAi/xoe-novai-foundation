Cline: Implementations & Remediation Manual
  Project Target: Xoe-NovAi Stack (AMD Ryzen 5000 / Vulkan 1.4)
  AI Code Assistant: Cline
  Manual Version: 1.2
  Audit Alignment Score: 88%

---

  Phase 1: Critical Remediation (Updated)
  Address these within 48 hours to ensure system integrity, security, and rootless operational stability.

### 1.1 IAM Persistence Layer
**Finding**: `app/XNAi_rag_app/iam_service.py` currently uses an in-memory `UserDatabase` mock.
**Remediation**:
- Replace the dict-based storage with a **SQLite persistent store**.
- Implement the `verify_password` method using `bcrypt.checkpw`.
- **Cline Instruction**: "Cline: Replace the `UserDatabase` class in `iam_service.py` with a **SQLite** implementation (via `sqlite-utils`) to ensure zero-loss data durability on Ryzen systems."

  1.2 Production Secrets Lockdown
  Finding: .env.example contains risk-prone placeholders; setup-prod-secrets.sh lacks environment pre-flights.
  Remediation:
   - Enforce Podman Secrets for REDIS_PASSWORD and API_KEY.
   - Update scripts/setup-prod-secrets.sh to validate openssl and podman presence before execution.
   - Cline Instruction: "Cline: Update scripts/setup-prod-secrets.sh to include pre-flight tool checks and ensure .env.example explicitly directs users to the Podman
     secret vault."

  1.3 Voice Recovery Completion
  Finding: app/XNAi_rag_app/voice_recovery.py contains truncated logic in Strategy 2.
  Remediation:
   - Complete the STT/TTS recovery handlers.
   - Integrate the EMERGENCY_MODE fallback (static error audio responses).
   - Cline Instruction: "Cline: Complete the _recover_stt_failure method in voice_recovery.py and ensure the EMERGENCY_MODE in voice_degradation.py is fully wired to
     local TTS fallbacks."

  1.4 Rootless Podman & UID Mapping Solidity
  Finding: Standard chown calls in setup scripts fail in rootless mode because the container's USER 1001 maps to a subordinate UID range on the host, not the host's
  actual 1001.
  Remediation:
   - Standardize Volume Mounts: Append the :Z suffix to all volume strings in podman-compose.yml for SELinux/permission labeling.
   - Implement `podman unshare`: Replace host-level chown with podman unshare chown -R 1001:1001 <dir> in bootstrap scripts.
   - Standardize Redis UID: Update the Redis service to run as ${APP_UID}:${APP_GID} instead of 999:999.
   - Cline Instruction: "Cline: Update scripts/setup_permissions.sh to use podman unshare for directory ownership and ensure all volume mounts in podman-compose.yml
     include the :Z flag."

---

  Phase 2: High-Priority Hardening (System Integrity)
  Address these within 7 days to align with Enterprise Standards.

  2.1 Dependency & Model Pinning
   - Action: Explicitly pin BART and Whisper model revisions in dependencies.py.
   - Cline Instruction: "Cline: Standardize model loading in app/XNAi_rag_app/dependencies.py by hardcoding specific validated model hashes."

  2.2 Latin & Scholarly Normalization
   - Action: Complete the _normalize_latin_text method in ingest_library.py to handle medieval orthographic variations (v/u, j/i).
   - Cline Instruction: "Cline: Extend the ScholarlyTextCurator class to include a full regex-based normalization mapping for medieval Latin variants."

  2.3 Bootstrap Consolidation
   - Action: Merge setup_volumes.sh and setup_permissions.sh into scripts/bootstrap_system.sh.
   - Cline Instruction: "Cline: Consolidate all pre-flight permission and volume scripts into a single, idempotent bootstrap utility."

---

  Phase 3: UX & Performance Optimization

  3.1 Real-time UI Visualization
   - Action: Wire the xoe_voice_audio_input_level Prometheus gauge to a visual waveform in the Chainlit UI.

### 3.2 Advanced YouTube Curation
- **Action**: Integrate **yt-dlp** into `crawl.py` to replace heuristic-based extraction. yt-dlp is torch-free and local-first.
- **Cline Instruction**: "Cline: Standardize on **yt-dlp** for sovereign metadata and transcript retrieval."

---

  Phase 4: Operational Standard Operating Procedures (SOPs)

  SOP-001: The "Cline" Build Process
  To maintain stack stability, Cline must adhere to this build sequence:
   1. make doctor (Environment Health)
   2. make wheel-build-docker (Guaranteed Python 3.12 Compatibility)
   3. ./scripts/enterprise_build.sh --full-build (12-Phase Orchestration)

  SOP-002: Rootless Verification
  After any permission changes, Cline must verify:
   1 podman exec xnai_rag_api touch /library/forge_test.txt
   2 # If success: UID mapping is solid.

---

  Manual Generated By: Cline Auditor (Gemini CLI)
  Status: Manual v1.2 - Corrected Nomenclature & Rootless Hardening Included.